{% set cart = craft.commerce.carts.cart %}

{% if cart.isEmpty %}
	{% redirect '#merch' %}
{% endif %}

{% set step = craft.app.request.param('step') %}

{% if not step %}
	{% redirect 'order?step=1' %}
{% endif %}

{% set showEmailForm = (step == 1) %}
{% set showEmailInfo = (not showEmailForm and cart.email) %}

{% set showShippingForm = (step == 2) %}
{% set showShippingInfo = (not showShippingForm and cart.shippingAddress) %}

{% set showPaymentForm = (step == 3) %}

{% if showPaymentForm and not cart.email %}
	{% redirect 'order?step=1' %}
{% endif %}

{% if showPaymentForm and not cart.shippingAddress %}
	{% redirect 'order?step=2' %}
{% endif %}

<section class="w-full flex flex-col items-center min-h-screen py-48 bg-tag-light-grey">
	<div class="w-full max-w-screen-xl bg-cool-gray-300 rounded-lg shadow-lg flex-grow h-full py-24 px-48">
		<header class="flex flex-row items-center content-center border-b-2 border-cool-gray-400 mb-12">
			<h2 class="font-bold text-xl mb-4 tag">{{ cart.lineitems[0].description }}</h2>
			<div class="mb-4">
				<span class="text-2xl align-top">$</span>
				<span class="text-5xl">{{ cart.itemTotal }}</span>
			</div>
		</header>
		<div class="flex flex-col">
			{% if showEmailForm %}
				<form method="POST" class="add-to-cart-form">
					<input type="hidden" name="action" value="commerce/cart/update-cart">
					{{ redirectInput('order?step=2') }}
					{{ csrfInput() }}
					<div>
						<label for="email" class="block text-sm font-medium leading-5 text-gray-700">Email</label>
						<div class="mt-1 relative rounded-md shadow-sm">
							<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
								<svg class="h-5 w-5 text-gray-400" viewbox="0 0 20 20" fill="currentColor">
									<path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
									<path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
								</svg>
							</div>
							<input id="email" name="email" type="email" value="{{cart.email}}" {% if currentUser %}} disabled {% endif %}} class="form-input block w-full pl-10 sm:text-sm sm:leading-5" placeholder="you@example.com"/>
						</div>
					</div>
					<div class="w-1/2">
						<button type="submit" class="bg-cool-gray-600 text-white w-full rounded px-3 py-3 ml-1 mt-6 text-sm hover:bg-cool-gray-800 outline-0">
							Next
						</button>
					</div>
				</form>
			{% endif %}
			{% if showEmailInfo %}
				{{ cart.email }}
				{% if not currentUser %}
					<a href="buy?step=1" class="text-blue block mt-5">Edit</a>
				{% endif %}
			{% endif %}
		</div>
		<div class="flex flex-col">
			{% if showShippingForm %}
				<form method="POST" class="add-to-cart-form">
					<input type="hidden" name="action" value="commerce/cart/update-cart">
					{{ redirectInput('buy?step=3') }}
					{{ csrfInput() }}

					{# Name Fields for Shipping #}
					<div class="flex flex-col md:flex-row">
						<div class="w-full md:w-1/2 p-4">
							<label for="first-name" class="block text-sm font-medium leading-5 text-gray-700 {% if cart.shippingAddress and cart.shippingAddress.getFirstError('firstName') %}text-red{% endif %}">First Name</label>
							<div class="mt-1 relative rounded-md shadow-sm">
								<input id="first-name" name="shippingAddress[firstName]" type="text" value="{{cart.shippingAddress.firstName ?? ''}}" class="form-input block w-full sm:text-sm sm:leading-5" placeholder="Jane"/>
							</div>
						</div>
						<div class="w-full md:w-1/2 p-4">
							<label for="last-name" class="block text-sm font-medium leading-5 text-gray-700 {% if cart.shippingAddress and cart.shippingAddress.getFirstError('lastName') %}text-red{% endif %}">Last Name</label>
							<div class="mt-1 relative rounded-md shadow-sm">
								<input id="last-name" name="shippingAddress[lastName]" type="text" value="{{cart.shippingAddress.lastName ?? ''}}" class="form-input block w-full sm:text-sm sm:leading-5" placeholder="Doe"/>
							</div>
						</div>
					</div>

					{# Address Fields for Shipping #}
					<div class="flex flex-col md:flex-row flex-wrap">
						<div class="w-full md:w-1/2 p-4">
							<label for="address1" class="block text-sm font-medium leading-5 text-gray-700 {% if cart.shippingAddress and cart.shippingAddress.getFirstError('address1') %}text-red{% endif %}">Address 1</label>
							<div class="mt-1 relative rounded-md shadow-sm">
								<input id="address1" name="shippingAddress[address1]" type="text" value="{{cart.shippingAddress.address1 ?? ''}}" class="form-input block w-full sm:text-sm sm:leading-5" placeholder="24 Arlington St."/>
							</div>
						</div>
						<div class="w-full md:w-1/2 p-4">
							<label for="address2" class="block text-sm font-medium leading-5 text-gray-700 {% if cart.shippingAddress and cart.shippingAddress.getFirstError('address2') %}text-red{% endif %}">Address 2</label>
							<div class="mt-1 relative rounded-md shadow-sm">
								<input id="address2" name="shippingAddress[address2]" type="text" value="{{cart.shippingAddress.address2 ?? ''}}" class="form-input block w-full sm:text-sm sm:leading-5" placeholder="Apt. 23"/>
							</div>
						</div>
					</div>

					{# City state and country fields #}
					<div class="flex flex-col md:flex-row flex-wrap">
						<div class="w-full md:w-2/3 p-4">
							<label for="city" class="block text-sm font-medium leading-5 text-gray-700 {% if cart.shippingAddress and cart.shippingAddress.getFirstError('city') %}text-red{% endif %}">City</label>
							<div class="mt-1 relative rounded-md shadow-sm">
								<input id="city" name="shippingAddress[city]" type="text" value="{{cart.shippingAddress.city ?? ''}}" class="form-input block w-full sm:text-sm sm:leading-5" placeholder="Asheville"/>
							</div>
						</div>
						<div class="w-1/2 md:w-1/3 p-4">
							<label for="zipCode" class="block text-sm font-medium leading-5 text-gray-700 {% if cart.shippingAddress and cart.shippingAddress.getFirstError('zipCode') %}text-red{% endif %}">Zip Code</label>
							<div class="mt-1 relative rounded-md shadow-sm">
								<input id="zipCode" name="shippingAddress[zipCode]" type="text" value="{{cart.shippingAddress.zipCode ?? ''}}" class="form-input block w-full sm:text-sm sm:leading-5" placeholder="28802"/>
							</div>
						</div>
						<div class="w-1/2 md:w-1/4 p-4">
							<label for="stateValue" class="block text-sm font-medium leading-5 text-gray-700 {% if cart.shippingAddress and cart.shippingAddress.getFirstError('stateValue') %}text-red{% endif %}">State</label>
							<div class="mt-1 relative rounded-md shadow-sm">
								<input id="stateValue" name="shippingAddress[stateValue]" type="text" value="{{cart.shippingAddress.stateValue ?? ''}}" class="form-input block w-full sm:text-sm sm:leading-5" placeholder="NC"/>
							</div>
						</div>
						<div class="w-1/2 md:w-1/4 p-4">
							<label for="country" class="block text-sm font-medium leading-5 text-gray-700 {% if cart.shippingAddress and cart.shippingAddress.getFirstError('country') %}text-red{% endif %}">Country</label>
							<div class="mt-1 relative rounded-md shadow-sm">
								<input id="country" name="shippingAddress[country]" type="text" value="{{cart.shippingAddress.country ?? ''}}" class="form-input block w-full sm:text-sm sm:leading-5" placeholder="USA"/>
							</div>
						</div>
					</div>

					<div class="flex">
						<div class="w-1/2">
							<input type="hidden" name="billingAddressSameAsShipping" value="1"/>
						</div>
						<div class="w-1/2">
							<button type="submit" class="bg-cool-gray-600 text-white w-full rounded px-3 py-3 ml-1 mt-6 text-sm hover:bg-cool-gray-800 outline-0">
								Next
							</button>
						</div>
					</div>


				</form>
			{% endif %}
			{% if showShippingInfo %}
				{{ cart.shippingAddress.firstName ?? ''}}
				{{ cart.shippingAddress.lastName ?? ''}}<br>
				{{ cart.shippingAddress.address1 ?? ''}}<br>
				{{ cart.shippingAddress.address2 ?? ''}}<br>
				{{ cart.shippingAddress.city ?? ''}},
				{{ cart.shippingAddress.zipCode ?? ''}}<br>
				{{ cart.shippingAddress.stateValue ?? ''}}
				{{ cart.shippingAddress.countryText ?? ''}}<br>
				<a href="buy?step=2" class="text-blue block mt-5">Edit</a>
			{% endif %}
		</div>


	</div>
</section>
